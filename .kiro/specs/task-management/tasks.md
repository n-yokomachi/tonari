# Implementation Plan

- [x] 1. DynamoDBタスクテーブルの作成
  - CDKで `tonari-tasks` テーブルを定義する（パーティションキー: `taskId`、ソートキーなし）
  - PAY_PER_REQUEST課金、RemovalPolicy: DESTROY を設定する
  - TTL属性 `ttl` を有効化して完了タスクの自動削除を構成する
  - WorkloadConstruct にテーブルプロパティを公開する
  - _Requirements: 9.1, 9.2_

- [x] 2. タスクCRUD APIの実装
- [x] 2.1 タスクCRUD Lambdaの実装
  - タスクの一覧取得（未完了のみ / 完了含む切替）、作成、更新、削除の各操作を実装する
  - タスク作成時にUUIDv4でタスクIDを生成し、sortOrderを既存最大値+1で設定する
  - タスク完了時に completedAt を記録し、TTLに完了日+30日のUNIXタイムスタンプを設定する
  - タスクの並び替えAPIを実装し、渡されたタスクID配列の順序に従って各タスクのsortOrderをバッチ更新する
  - userId は `tonari-owner` 固定とし、既存のdiary-crud Lambdaのパターン（HTTPメソッドルーティング、CORSヘッダー、日本語対応）に準拠する
  - _Requirements: 2.2, 2.4, 2.6, 3.2, 4.2, 9.3_

- [x] 2.2 API GatewayルートとCDK設定の追加
  - WorkloadConstruct に task-crud Lambda を追加し、タスクテーブルへの読み書き権限を付与する
  - API Gateway に `/tasks` リソースを追加し GET, POST, PUT メソッドを登録する（Cognito M2Mオーソライザ付き）
  - `/tasks/{taskId}` サブリソースに GET, PUT, DELETE メソッドを登録する
  - `/tasks/reorder` サブリソースに PUT メソッドを登録する
  - _Requirements: 9.4_

- [x] 3. MCPタスクツールの実装
- [x] 3.1 タスクツールLambdaの実装
  - Gateway ToolとしてプレーンJSON入力を受け取り、操作種別に応じたタスク操作を実行する
  - タスク一覧取得（期限N日以内フィルタ対応）、タスク追加、タスク完了、タスク更新の4操作を実装する
  - 既存のdiary-tool Lambdaのイベント処理パターンに準拠する
  - _Requirements: 7.1_

- [x] 3.2 MCPゲートウェイターゲットの登録
  - AgentCoreConstruct props に `taskToolLambda` を追加し、Gateway Role の Lambda 呼び出し権限にタスクツールLambdaを含める
  - ゲートウェイに `task-tool` ターゲットを登録し、`list_tasks`、`add_task`、`complete_task`、`update_task` の4ツールスキーマをインラインで定義する
  - WorkloadConstruct からタスクツールLambdaを公開し、スタック側で AgentCoreConstruct に渡す
  - _Requirements: 7.1_

- [x] 4. フロントエンドAPIプロキシの実装
  - Next.js API ルートでタスクのCRUD操作をバックエンドAPI Gatewayにプロキシする
  - 既存の diary API プロキシパターンに準拠し、Admin認証チェック → Cognitoトークン取得 → プロキシの流れを実装する
  - タスク一覧取得、作成、更新、削除、並び替えの各エンドポイントを用意する
  - パスパラメータ（taskId）を含むリクエストを適切にルーティングする
  - _Requirements: 9.4_

- [x] 5. タスク状態管理ストアの実装
  - Zustand + persist ミドルウェアでタスクの状態管理ストアを作成する
  - APIからのタスクデータフェッチ、キャッシュ、楽観的更新（追加・編集・完了・削除・並び替え）を実装する
  - エラー発生時にリフェッチでデータの整合性を回復する仕組みを組み込む
  - UI状態（パネル表示/非表示、完了タスク表示/非表示）を partialize でローカル永続化する
  - 期限3日以内の未完了タスク数を動的に計算する urgentTaskCount を実装する
  - _Requirements: 1.1, 1.4, 6.1_
  - _Contracts: taskStore Service Interface, State Management_

- [x] 6. タスクリストUIの基本実装
- [x] 6.1 フローティングパネルとメニュー統合
  - PomodoroTimerのパターンに倣い、PointerEventsによるドラッグ移動が可能なフローティングパネルを作成する
  - Apple風ガラスモーフィズムUIを適用する（半透明白背景 + backdrop-blur）
  - パネル位置を localStorage に永続化し、画面回転時にリセットする
  - フェードイン/フェードアウトのトランジションを実装する
  - メニューバー（デスクトップ + モバイルヘッダー）にタスクアイコンを追加し、クリックでパネルの表示/非表示を切り替える
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 6.2 タスクの表示・追加・編集
  - 各タスクを丸型チェックボックス付きのリスト形式で表示する
  - 追加ボタンクリックで新しいタスクの入力欄を表示し、タスク名を入力して確定すると保存する
  - 既存タスクのタスク名をクリックするとインライン編集可能な状態にする
  - _Requirements: 1.5, 2.1, 2.2, 2.3_

- [x] 6.3 タスクの完了処理とジェスチャー再生
  - 丸型チェックボックスをクリックするとタスクを完了状態に変更し、フェードアウトでタスクリストから非表示にする
  - タスク完了時にVRMモデルの cheer ジェスチャーを再生する
  - _Requirements: 2.4, 2.5_

- [x] 7. (P) 期限管理機能の実装
- [x] 7.1 (P) カレンダー日付ピッカーと期限表示
  - タスクの期限エリアをクリックするとネイティブの日付ピッカーを表示し、日付を選択すると期限として保存する
  - 期限が設定されているタスクのタスク名近くに期限日を表示する
  - 期限を過ぎているタスクは期限表示を警告色（赤系）で表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 7.2 (P) 期限アラートとアイコンバッジ
  - 期限が3日以内に迫っている未完了タスクが存在する場合、メニューバーのタスクアイコンにバッジを表示する
  - タスクリストを開いた際に、期限の近いタスクを視覚的に強調表示する（背景色やボーダーの変化）
  - _Requirements: 6.1, 6.3_

- [x] 8. (P) タスク並び替え機能の実装
  - タスクをPointerEventsでドラッグし、移動先をビジュアルフィードバック（ドロップインジケーター）で示す
  - ドラッグ中のタスクを半透明や浮き上がりで視覚的に区別する
  - ドロップ時にタスクの表示順序を更新し、バックエンドに並び替え結果を保存する
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 9. (P) 完了タスク閲覧機能の実装
  - タスクリスト横に完了タスク表示用の矢印アイコンを配置する
  - 矢印アイコンをクリックすると完了済みタスクの一覧を表示し、各タスクに完了日時を表示する
  - 矢印アイコンを再度クリックすると完了タスク一覧を非表示にする
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 10. (P) ニュースブリーフィングへのタスク統合
  - news-trigger Lambda の起動時にタスクテーブルから期限3日以内の未完了タスクを取得する
  - 該当タスクが存在する場合、ニュース生成プロンプトに期限の近いタスク一覧を含め、冒頭でリマインドするよう指示する
  - CDKで news-trigger Lambda にタスクテーブルの読み取り権限と環境変数を追加する
  - 該当タスクがない場合はタスクセクションを省略する
  - _Requirements: 6.2_

- [x] 11. エージェントプロンプトへのタスク機能統合
- [x] 11.1 (P) タスクツール使用指示の追加
  - システムプロンプトにタスク管理ツール（list_tasks, add_task, complete_task, update_task）の使用方法と使いどころを記述する
  - 「タスクを追加して」「近いタスクはある？」等の依頼に対してツールを呼び出す指示を追加する
  - タスク内容と会話の文脈を踏まえたネクストアクション提案のガイドラインを記述する
  - _Requirements: 7.2, 7.3, 7.4_

- [x] 11.2 (P) 会話中のタスク自動検出ルールの追加
  - オーナーの発言に期限や行動を示す表現（「明日までに〜しなきゃ」「来週〜する」等）が含まれている場合に「タスクに追加しましょうか？」と提案するルールをシステムプロンプトに追加する
  - オーナーが承認した場合はタスク管理ツールで自動追加し、拒否した場合は追加せず会話を続行する指示を記述する
  - _Requirements: 8.1, 8.2, 8.3_
