# Requirements Document

## Introduction
カメラ連携機能の要件定義。ユーザーのWebカメラからスナップショットを撮影し、REST API経由でbase64エンコード画像をAgentCoreバックエンドに送信する。Strands AgentsのメッセージコンテンツとしてClaude Vision（Haiku 4.5）に画像を渡し、視覚情報に基づいた応答をScenseiエージェントが返す。

2フェーズに分けて実装する:
- **Phase 1（ユーザー起動型）**: ボタン押下で1枚撮影・送信するスナップショット型。ユーザーが明示的にカメラ操作を行う。
- **Phase 2（エージェント起動型）**: LLMの応答に含まれるタグ（`[camera]`）をトリガーに、フロントエンドが自動でスナップショットを撮影しLLMに送り返す。既存の感情タグ（`[happy]`等）やジェスチャータグ（`[bow]`等）と同様の仕組み。

## Requirements

### Phase 1: ユーザー起動型スナップショット

### Requirement 1: カメラアクセスとプレビュー表示
**Objective:** ユーザーとして、Webカメラの映像をリアルタイムでプレビュー表示したい。これにより、撮影前に映り具合を確認できる。

#### Acceptance Criteria
1.1. When ユーザーがカメラ機能を有効化した時, the フロントエンドアプリケーション shall getUserMedia APIを使用してWebカメラへのアクセスを要求する
1.2. When カメラアクセスが許可された時, the フロントエンドアプリケーション shall カメラ映像のリアルタイムプレビューをUI上に表示する
1.3. If ユーザーがカメラアクセスを拒否した場合, the フロントエンドアプリケーション shall カメラが使用できない旨のメッセージを表示し、テキストのみの通常チャットを継続可能にする
1.4. If ブラウザがgetUserMedia APIをサポートしていない場合, the フロントエンドアプリケーション shall カメラ機能が利用不可であることを表示し、カメラ関連UIを非表示にする
1.5. When ユーザーがカメラ機能を無効化した時, the フロントエンドアプリケーション shall カメラストリームを停止し、プレビュー表示を非表示にする

### Requirement 2: スナップショット撮影と送信UI
**Objective:** ユーザーとして、ボタン1つでカメラ画像を撮影し、チャットメッセージと一緒に送信したい。これにより、視覚情報を手軽にエージェントに共有できる。

#### Acceptance Criteria
2.1. While カメラプレビューが表示されている間, the フロントエンドアプリケーション shall スナップショット撮影ボタンを表示する
2.2. When ユーザーがスナップショット撮影ボタンを押した時, the フロントエンドアプリケーション shall カメラ映像から静止画を1枚キャプチャし、プレビューとして表示する
2.3. When スナップショットがキャプチャされた時, the フロントエンドアプリケーション shall キャプチャ画像のプレビューと、送信ボタン・撮り直しボタンを表示する
2.4. When ユーザーが撮り直しボタンを押した時, the フロントエンドアプリケーション shall キャプチャ画像を破棄し、カメラプレビュー状態に戻る
2.5. When ユーザーが画像付きメッセージを送信した時, the フロントエンドアプリケーション shall テキストメッセージと画像を同時にバックエンドに送信する
2.6. The フロントエンドアプリケーション shall テキストなし（画像のみ）でも送信を許可する

### Requirement 3: 画像エンコードと送信
**Objective:** フロントエンドとして、キャプチャ画像をbase64エンコードし、既存のREST APIを通じてAgentCoreバックエンドに送信したい。これにより、アーキテクチャ変更を最小限に抑えられる。

#### Acceptance Criteria
3.1. When スナップショットがキャプチャされた時, the フロントエンドアプリケーション shall Canvas APIを使用してカメラ映像からJPEG形式の画像データを取得する
3.2. The フロントエンドアプリケーション shall キャプチャ画像をbase64エンコードして送信する
3.3. The フロントエンドアプリケーション shall 送信する画像サイズを適切にリサイズし、APIペイロードの肥大化を防ぐ（長辺最大1024pxを目安）
3.4. When 画像付きメッセージを送信する時, the フロントエンドアプリケーション shall 既存のチャットAPIエンドポイントを拡張して画像データを含むリクエストを送信する

### Requirement 4: バックエンド画像処理
**Objective:** バックエンドとして、受信した画像データをStrands AgentsのメッセージコンテンツとしてClaude Visionに渡したい。これにより、LLMが画像を直接分析できる。

#### Acceptance Criteria
4.1. When 画像付きリクエストを受信した時, the バックエンドAPIエンドポイント shall リクエストからbase64画像データを抽出し、Strands Agentsのメッセージコンテンツ形式に変換する
4.2. When 画像をStrands Agentに渡す時, the バックエンドAPIエンドポイント shall `{"type": "image", "image": {"format": "jpeg", "source": {"bytes": base64データ}}}` 形式のコンテンツブロックとしてメッセージに含める
4.3. When 画像とテキストの両方が含まれるリクエストの場合, the バックエンドAPIエンドポイント shall テキストコンテンツと画像コンテンツの両方をメッセージコンテンツとして渡す
4.4. If 画像データが不正または処理できない場合, the バックエンドAPIエンドポイント shall エラーメッセージを返し、テキストのみでの会話を継続可能にする

### Requirement 5: 視覚情報に基づく応答
**Objective:** ユーザーとして、エージェントに画像を見せて、視覚情報に基づいたアドバイスを受けたい。これにより、服装や場の雰囲気に合わせた香水提案が可能になる。

#### Acceptance Criteria
5.1. When 画像付きメッセージを受信した時, the Scenseiエージェント shall 画像の内容を分析し、視覚情報を考慮した応答を返す
5.2. The Scenseiエージェント shall 画像分析結果を香水ソムリエとしてのキャラクター設定に沿った自然な会話文で伝える
5.3. When 画像から服装やシーンが読み取れた場合, the Scenseiエージェント shall それに合わせた香水提案を行う
5.4. If 画像の内容が不鮮明または香水提案に関連しない場合, the Scenseiエージェント shall その旨を伝えつつ、会話を継続する

### Requirement 6: UXとフィードバック
**Objective:** ユーザーとして、画像送信中の状態が分かるようにしたい。これにより、操作の進行状況を把握でき、安心して利用できる。

#### Acceptance Criteria
6.1. While 画像付きメッセージを送信中の間, the フロントエンドアプリケーション shall 送信中であることを示すローディング表示をする
6.2. When 画像付きメッセージの送信が完了した時, the フロントエンドアプリケーション shall 送信した画像のサムネイルをチャット履歴に表示する
6.3. If 画像の送信に失敗した場合, the フロントエンドアプリケーション shall エラーメッセージを表示し、再送信を可能にする
6.4. The フロントエンドアプリケーション shall カメラ機能はオプショナルとし、カメラを使用しなくても既存のチャット機能に影響を与えない

### Phase 2: エージェント起動型スナップショット

### Requirement 7: カメラタグによる自動撮影トリガー
**Objective:** ユーザーとして、エージェントが自発的に「見せてください」と判断した時に自動でスナップショットが撮影・送信されるようにしたい。これにより、エージェントが自ら視覚情報を取得する「目を持つ」体験が実現できる。

#### Acceptance Criteria
7.1. When LLMの応答に `[camera]` タグが含まれていた時, the フロントエンドアプリケーション shall 既存の感情タグ・ジェスチャータグと同様にタグをパースして検出する
7.2. When `[camera]` タグが検出された時 and カメラアクセスが許可済みの場合, the フロントエンドアプリケーション shall 自動的にWebカメラからスナップショットを1枚キャプチャする
7.3. When 自動キャプチャが完了した時, the フロントエンドアプリケーション shall キャプチャ画像を自動的にバックエンドに送信し、LLMが画像を分析して追加の応答を返す
7.4. If `[camera]` タグが検出された時 and カメラアクセスが未許可または無効の場合, the フロントエンドアプリケーション shall カメラが利用できない旨をバックエンドに通知し、LLMがテキストのみで会話を継続する
7.5. The フロントエンドアプリケーション shall `[camera]` タグをチャット表示テキストからは除去し、ユーザーにはタグを見せない

### Requirement 8: エージェント起動型のシステムプロンプト
**Objective:** Scenseiエージェントとして、会話の文脈に応じて適切なタイミングでカメラタグを使用したい。これにより、自然な会話の流れの中で視覚情報を取得できる。

#### Acceptance Criteria
8.1. The Scenseiエージェントのシステムプロンプト shall `[camera]` タグの使用ルール（使用タイミング、使用例）を含む
8.2. When ユーザーが服装やシーンに関する相談をした時, the Scenseiエージェント shall `[camera]` タグを使って視覚情報の取得を試みる
8.3. The Scenseiエージェント shall `[camera]` タグは1つの応答につき最大1回のみ使用する
8.4. The Scenseiエージェント shall ユーザーが明示的にカメラを使いたくないと示した場合は `[camera]` タグの使用を控える

### Requirement 9: 自動撮影のUXフィードバック
**Objective:** ユーザーとして、エージェントが自動で撮影していることが分かるようにしたい。これにより、プライバシーに対する安心感が得られる。

#### Acceptance Criteria
9.1. When `[camera]` タグによる自動キャプチャが実行された時, the フロントエンドアプリケーション shall 撮影が行われたことを示す視覚的な通知（アニメーション等）を表示する
9.2. When 自動キャプチャ画像がバックエンドに送信された時, the フロントエンドアプリケーション shall 送信された画像のサムネイルをチャット履歴に表示する
9.3. The フロントエンドアプリケーション shall エージェント起動型の自動撮影を無効にするオプションを提供する
