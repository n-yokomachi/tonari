# Implementation Plan

- [x] 1. AITuber-kit由来の不要マルチモーダルコードを削除する
  - VideoDisplay、ModalImage、関連カスタムフック（useDraggable、useResizable）を全削除する
  - フォーム内のマルチモーダルモード判定ロジック（multiModalMode、isMultiModalAvailable、enableMultiModal）を削除する
  - AIモデル定数ファイルからマルチモーダル関連関数（isMultiModalAvailable、multiModalModels等）を削除する
  - 設定ストアからmultiModalMode、enableMultiModal、imageDisplayPosition関連の状態を削除する
  - メッセージ入力コンポーネントからマルチモーダル判定の参照を削除する
  - 削除後にビルドが通ることを確認し、既存のテキストチャット機能に影響がないことを検証する

- [x] 2. バックエンド画像処理パイプラインを構築する
- [x] 2.1 (P) AgentCoreエントリポイントで画像データをStrands Agent形式に変換する機能を実装する
  - リクエストペイロードからbase64画像データを抽出し、raw bytesにデコードする
  - テキストのみの場合は既存の文字列プロンプト、画像がある場合はテキスト+画像のContentBlockリストを構築する
  - 不正なbase64データの場合はテキストのみにフォールバックし、ログを出力する
  - テキストのみ、テキスト+画像、画像のみ、不正base64の各パターンのユニットテストを作成する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 2.2 (P) Next.js APIルートでフロントエンドからの画像データをAgentCore Runtimeに中継する機能を実装する
  - リクエストボディからimageBase64とimageFormatを抽出し、AgentCoreへのペイロードに含める
  - 画像なしの場合は既存の動作を維持する（後方互換性）
  - _Requirements: 3.4, 4.4_

- [x] 3. カメラプレビューUIを構築する
- [x] 3.1 カメラアクセスとリアルタイムプレビュー表示を実装する
  - getUserMedia APIを使用してWebカメラへのアクセスを要求し、video要素でライブ映像を表示する
  - メッセージ入力欄付近にカメラアイコンボタンを配置し、押下でプレビューを表示する
  - カメラアクセス拒否時はカメラが使用できない旨のメッセージを表示し、テキストチャットを継続可能にする
  - getUserMedia非対応ブラウザではカメラ関連UIを非表示にする
  - カメラ無効化時はストリームを停止し、プレビューを非表示にする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 6.4_

- [x] 3.2 スナップショット撮影・リサイズ・撮影プレビューを実装する
  - カメラプレビュー表示中に撮影ボタンを表示し、押下でCanvas APIを使いJPEG形式（quality 0.85）でキャプチャする
  - キャプチャ画像を長辺最大1024pxにリサイズする
  - キャプチャ後はプレビュー画像と送信ボタン・撮り直しボタンを表示する
  - 撮り直しボタンでキャプチャを破棄しカメラプレビュー状態に戻る
  - キャプチャ画像をdata URLとしてストアに保存する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.3_

- [x] 4. 画像付きメッセージの送受信パイプラインを統合する
- [x] 4.1 チャット送信時に画像データを含むAPIリクエストを送信する仕組みを実装する
  - メッセージ送信時にストアのキャプチャ画像を参照し、存在すればdata URLプレフィックスを除去してbase64データとしてAPIリクエストに含める
  - テキストなし（画像のみ）でも送信を許可する
  - 送信後にキャプチャ画像をクリアする
  - SSEストリーミングレスポンスの処理は既存ロジックを維持する
  - _Requirements: 2.5, 2.6, 3.2, 3.4_

- [x] 4.2 チャット履歴での画像サムネイル表示と送信状態のフィードバックを実装する
  - 画像付きメッセージ送信中はローディング表示をする
  - 送信完了後、チャット履歴に送信した画像のサムネイルを表示する
  - 送信失敗時はエラーメッセージを表示し、再送信を可能にする
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 5. (P) 画像分析ガイドラインをシステムプロンプトに追加する
  - 画像付きメッセージを受信した際の応答ガイドライン（視覚情報の分析、キャラクター設定に沿った応答）を追加する
  - 画像から服装やシーンが読み取れた場合の香水提案ルールを追加する
  - 画像が不鮮明または香水提案に関連しない場合のフォールバック対応を追加する
  - 既存のフォーマットルール（Markdown禁止、感情タグ、ジェスチャータグ）との整合性を維持する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 6. [camera]タグによるエージェント起動型スナップショットを実装する
- [x] 6.1 LLM応答中の[camera]タグ検出と自動キャプチャ・送信を実装する
  - ストリーミング応答テキストから[camera]タグを検出するパーサーを実装する（既存の感情タグ・ジェスチャータグと同様のパターン）
  - [camera]タグをチャット表示テキストから除去する
  - タグ検出時にカメラアクセスが許可済みであれば自動キャプチャを実行する
  - ストリーム完了後に自動キャプチャ画像をバックエンドに送信し、LLMの画像分析応答を受け取る
  - カメラが未許可または無効の場合はバックエンドにカメラ利用不可を通知し、テキストのみで会話を継続する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6.2 (P) [camera]タグの使用ルールをシステムプロンプトに追加する
  - [camera]タグの使用タイミング（服装相談、シーンに関する質問時など）と使用例を追加する
  - 1応答あたり最大1回の使用制限を明記する
  - ユーザーがカメラを使いたくないと示した場合はタグ使用を控えるルールを追加する
  - ジェスチャータグとの併用ルールを明確にする
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 6.3 自動撮影のUXフィードバックと無効化オプションを実装する
  - [camera]タグによる自動キャプチャ実行時に撮影通知（アニメーション等）を表示する
  - 自動キャプチャ画像のサムネイルをチャット履歴に表示する
  - エージェント起動型の自動撮影を無効にするオプションを提供する
  - _Requirements: 9.1, 9.2, 9.3_
