# Implementation Plan

## Requirements Coverage

全25件の受入基準を5つのメジャータスク、10のサブタスクでカバー。

| Requirement Group | IDs | Task |
|-------------------|-----|------|
| Gmail連携ツール | 1.1-1.7 | 1, 2 |
| ブリーフィングモード | 2.1-2.8 | 4, 5 |
| 週間支出トラッキング | 3.1-3.6 | 4.2 |
| チャットログ分割 | 4.1-4.6 | 3 |
| ブリーフィングUI | 5.1-5.3 | 5 |

---

- [ ] 1. gmail-tool Lambda 実装
- [ ] 1.1 OAuth2認証とメール検索機能の実装
  - calendar-tool と同一の OAuth2 認証パターンで Gmail サービスを初期化する（SSM Parameter Store から認証情報を取得）
  - Gmail 検索クエリ（`is:unread`, `newer_than:1d`, `from:` 等の Gmail 検索構文）を受け取り、メール一覧をメタデータ付きで返す `search_emails` ツールを実装する
  - `messages.list` は ID のみ返却するため、取得した ID に対して `messages.get(format="metadata")` で件名・差出人・日時・snippet を2パスで取得する
  - 前提: OAuth2 refresh token に `gmail.modify` + `gmail.compose` スコープを追加する再認証が必要（手動セットアップ手順をオーナーに案内）
  - _Requirements: 1.1, 1.5, 1.6_

- [ ] 1.2 メール本文取得とMIMEパース機能の実装
  - 指定されたメール ID の本文全文を取得する `get_email` ツールを実装する
  - `messages.get(format="full")` でメッセージを取得し、multipart MIME 構造から本文を抽出する
  - text/plain パートを優先的に取得し、存在しない場合は text/html からタグを除去して返す
  - 件名・差出人・宛先・日時・本文・ラベル一覧を構造化して返却する
  - _Requirements: 1.2_

- [ ] 1.3 下書き作成・アーカイブ機能の実装
  - 宛先・件名・本文を受け取り Gmail の下書きを作成する `create_draft` ツールを実装する（RFC 2822 形式で base64url エンコード）
  - スレッドへの返信下書きに対応するため、オプションの `thread_id` パラメータを受け付ける
  - 指定メールの既読化（UNREAD ラベル除去）とアーカイブ（INBOX ラベル除去）を1リクエストで行う `archive_email` ツールを実装する
  - メール送信機能は実装しない（下書き作成・既読化・アーカイブまでの操作に限定）
  - _Requirements: 1.3, 1.4, 1.7_

- [ ] 2. gmail-tool CDK インフラ統合
  - Lambda 関数定義を workload-construct に追加する（Python 3.12、タイムアウト 30秒、SSM 読取り権限）
  - MCP Gateway Target を agentcore-construct に追加し、4つのツール（search_emails, get_email, create_draft, archive_email）のスキーマを定義する
  - tonari-stack で Lambda 参照を AgentCore コンストラクトに渡す
  - 既存の calendar-tool と同一の IAM credential パターンで Gateway を構成する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 3. (P) チャットログ分割ロジック実装
- [ ] 3.1 ツール呼び出し境界でのチャットバブル分割
  - SSE ストリーム処理中に `tool_start` イベントを受信した際、現在蓄積中のテキストメッセージを確定し、メッセージ ID をリセットする
  - ツール完了後の次のテキストチャンクから新しいメッセージ ID で新規バブルを開始する
  - ツール呼び出しを含まない応答の場合は従来通り1つのバブルにまとめる
  - 既存の感情タグ・ジェスチャータグ・カメラタグ処理との競合を避け、最初のバブルのみ感情タグを適用する
  - _Requirements: 4.2, 4.3, 4.5_

- [ ] 3.2 空行（2連続改行）によるチャットバブル分割
  - テキスト蓄積中に `\n\n`（空行）を検出した場合、空行の前のテキストで現在メッセージを確定し、空行の後のテキストで新メッセージを開始する
  - チャンク境界をまたぐ `\n\n` に対応する（前チャンク末尾 `\n` + 新チャンク先頭 `\n`）
  - 1つのチャンク内に複数の `\n\n` が含まれる場合、すべての分割ポイントで分割する
  - 分割されたバブル内の単一改行（`\n`）と箇条書き（「・」等）は正しく表示されることを確認する
  - _Requirements: 4.1, 4.4, 4.5, 4.6_

- [ ] 4. (P) システムプロンプト更新
- [ ] 4.1 Gmail ツール説明の追加
  - search_emails, get_email, create_draft, archive_email の4ツールの使い方・パラメータ・戻り値をシステムプロンプトに追記する
  - 「アーカイブして」指示で既読化+アーカイブを一括実行する旨を明記する
  - メール送信は不可であり、下書き作成までの範囲に限定される旨を明記する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.7_

- [ ] 4.2 ブリーフィングモード手順・出力フォーマット指示の追加
  - 「ブリーフィングして」「ブリーフィングお願い」等のトリガーフレーズを認識してブリーフィングを開始する手順を記述する
  - 5リソースの順次チェック手順を定義する:（a）カレンダー今日・翌日 →（b）メールトリアージ →（c）タスク期限チェック →（d）天気 →（e）週間支出
  - 各セクション間に空行（`\n\n`）を挿入してチャットバブルが分割されるよう出力フォーマットを指示する
  - メールトリアージでは未読メールの傾向を要約し、確認が必要なメール（アラート、重要連絡等）をタイトルと本文要約付きでハイライトする指示を記述する
  - タスクが無い場合や支出情報が無い場合のスキップ・簡潔報告条件を定義する
  - 週間支出トラッキングの手順を記述する: 月曜始まりの今週分の購入確認メールを検索し、金額を抽出・合計し、「今週の支出: 約〇〇円（〇件）」形式で報告する
  - 購入サイトとカード会社の重複排除判断基準（金額・日付・店舗名の類似性）と、重複除外・金額不確実の注記ルールを定義する
  - Markdown 形式を避け、改行と「・」による箇条書きのプレーンテキストで出力する指示を記述する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 5. (P) ブリーフィングUIボタン追加
  - デスクトップのコントロールパネルにブリーフィングボタンを追加する（既存の TaskIconButton と同列の配置）
  - モバイル/縦モニターのヘッダーにも同様のボタンを追加する
  - ボタンクリック時にエージェントへ「ブリーフィングお願い」メッセージを送信する
  - エージェント処理中はボタンを非活性化またはローディング表示にする（chatProcessing 状態を参照）
  - ブリーフィングを表す SVG アイコンを作成して配置する
  - _Requirements: 2.1, 5.1, 5.2, 5.3_
