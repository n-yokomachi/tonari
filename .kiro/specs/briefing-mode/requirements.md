# Requirements Document

## Introduction

ブリーフィングモード機能の要件定義。オーナーが会話またはUIボタンからブリーフィングを依頼すると、Gmail・カレンダー・タスクリスト・天気情報を横断的にチェックし、対応が必要な項目を要約・報告する。また、Gmail連携ツール（メール参照・下書き作成）、メモリを活用した文脈に基づくフォローアップ、購入メールからの週間支出トラッキング、チャットログの分割表示を実装する。

## Requirements

### Requirement 1: Gmail連携ツール

**Objective:** As a オーナー, I want エージェントを通じて個人のGmailメールを参照し、下書きを作成できるようにしたい, so that メールの確認と返信準備をアシスタントに任せられる

#### Acceptance Criteria

1.1. When オーナーがメールの確認を依頼した場合, the gmail-tool shall Gmail APIを使用して受信メールを検索し、件名・差出人・日時・本文プレビューを返す

1.2. When オーナーが特定のメールの詳細を依頼した場合, the gmail-tool shall 指定されたメールIDの本文全文を取得して返す

1.3. When オーナーがメールの下書き作成を依頼した場合, the gmail-tool shall 指定された宛先・件名・本文でGmailの下書きを作成し、下書きIDを返す

1.4. When オーナーが「アーカイブして」と依頼した場合, the gmail-tool shall 指定されたメールIDのメールを既読（UNREADラベル除去）にし、同時にアーカイブ（INBOXラベル除去）する

1.5. The gmail-tool shall 検索クエリ（Gmail検索構文: is:unread, newer_than:1d, from:等）によるフィルタリングに対応する

1.6. The gmail-tool shall 既存のGoogle OAuth2認証情報（SSM Parameter Store）を再利用し、Gmailスコープ（gmail.modify, gmail.compose）を追加する

1.7. The gmail-tool shall メール送信機能を持たない（参照・下書き作成・既読化・アーカイブまで）

### Requirement 2: ブリーフィングモード

**Objective:** As a オーナー, I want 朝の会話起点でカレンダー・メール・タスク・天気を横断的にチェックしてもらいたい, so that 1日の始まりに対応すべき項目を効率的に把握できる

#### Acceptance Criteria

2.1. When オーナーがUI上のブリーフィングボタンを押した場合, the Tonariエージェント shall ブリーフィングモードを起動する

2.2. When オーナーが「ブリーフィングして」「ブリーフィングお願い」等の自然言語で依頼した場合, the Tonariエージェント shall ブリーフィングモードを起動する

2.3. While ブリーフィングモード実行中, the Tonariエージェント shall 以下の5つのリソースを順次チェックする: (a) Googleカレンダーの今日・翌日の予定, (b) Gmailの未読メールのトリアージ, (c) タスクリストの期限が迫っているタスク, (d) 今日の東京の天気, (e) 今週（月曜始まり）の支出サマリー

2.4. While ブリーフィングモード実行中 and タスクリストに期限の迫っているタスクがない場合, the Tonariエージェント shall タスクセクションをスキップまたは「期限の迫っているタスクはありません」と簡潔に報告する

2.5. While ブリーフィングモード実行中, the Tonariエージェント shall 各リソースの結果をセクションごとに分けてチャットログに報告する

2.6. The Tonariエージェント shall ブリーフィング結果をMarkdown形式ではなく、改行と「・」による箇条書きを使ったプレーンテキストで出力する

2.7. While ブリーフィングモード実行中, the Tonariエージェント shall 未読メールを分類し、全体の傾向を要約した上で、確認が必要なメール（アラート、重要な連絡等）をタイトルと本文要約付きでハイライトする（例:「新着メールは主にAmazonやUber Eatsの購入履歴です。ただしAWSからアラートが来ているので確認をお願いします」）

2.8. While ブリーフィングモード実行中 and 今週の支出情報がない場合, the Tonariエージェント shall 支出セクションをスキップまたは「今週の購入メールは見つかりませんでした」と簡潔に報告する

### Requirement 3: 週間支出トラッキング

**Objective:** As a オーナー, I want Gmailの購入確認メールから今週の支出を自動計算してほしい, so that 支出状況を意識せずに把握できる

#### Acceptance Criteria

3.1. When ブリーフィング中に支出チェックが実行された場合, the Tonariエージェント shall Gmailから今週（月曜始まり〜現在）の購入確認・注文確認メールを検索する

3.2. The Tonariエージェント shall 購入確認メール（Amazon、楽天、Apple等の主要ECサイト）から金額を抽出し、今週の合計支出を計算する

3.3. The Tonariエージェント shall 支出情報を「今週の支出: 約〇〇円（〇件）」の形式で、内訳と合わせて報告する

3.4. While 支出計算中, the Tonariエージェント shall 購入サイトからの注文確認メールとクレジットカード会社からの利用通知メールで同一取引が重複しないよう、金額・日付・店舗名の類似性に基づいて重複排除を行う

3.5. If 重複の可能性がある取引が検出された場合, the Tonariエージェント shall 重複と判断した件数を「重複と思われる〇件を除外しました」と注記する

3.6. If 金額の抽出が不確実な場合, the Tonariエージェント shall 「金額を正確に読み取れなかったメールがあります」と注記する

### Requirement 4: チャットログ分割表示

**Objective:** As a オーナー, I want エージェントの応答が適切な粒度で別のチャットバブルに分かれるようにしたい, so that 長いブリーフィング結果や複数ステップの応答が読みやすくなる

#### Acceptance Criteria

4.1. When エージェントのテキスト応答中に空行（2連続改行）が検出された場合, the チャットUI shall 空行の前後を別々のチャットバブルとして表示する

4.2. When エージェントがテキスト応答中にツールを呼び出した場合, the チャットUI shall ツール呼び出し前のテキストと呼び出し後のテキストを別々のチャットバブルとして表示する

4.3. While エージェントがSSEストリーミング中にtool_startイベントを受信した場合, the チャットUI shall 現在のメッセージを確定し、ツール完了後の新しいテキストを新しいメッセージIDで開始する

4.4. While エージェントがSSEストリーミング中に空行（\n\n）を受信した場合, the チャットUI shall 現在のメッセージを確定し、空行以降のテキストを新しいメッセージIDで開始する

4.5. When エージェントがツール呼び出しも空行も含まない応答をした場合, the チャットUI shall 従来通り1つのチャットバブルにまとめて表示する

4.6. The チャットUI shall 分割されたチャットバブルにおいても、改行と箇条書き（「・」等）を正しく表示する

### Requirement 5: ブリーフィングUI

**Objective:** As a オーナー, I want ブリーフィングを手軽に起動できるUIが欲しい, so that 毎朝素早くブリーフィングを開始できる

#### Acceptance Criteria

5.1. The メインUI shall ブリーフィングを起動するためのボタンをコントロールパネルに配置する

5.2. When ブリーフィングボタンが押された場合, the メインUI shall エージェントに対してブリーフィング開始のメッセージを送信する

5.3. While ブリーフィングモード実行中, the ブリーフィングボタン shall 処理中であることを視覚的に示す（非活性化またはローディング表示）
